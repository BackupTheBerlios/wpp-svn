<?php

//include(WPP_BASE.WPP_ROOT.'/includes/functions/db.inc');

class User {

	var $read_content = 0;
	var $write_content = 0;
	var $purchase = 0;
	var $read_orders = 0;
	var $write_orders = 0;
	
	var $role = null;	// speichert noch einmal die Rollen-ID
	
	var $name = null;
	var $lastname = null;
	var $email = null;
	var $id = null;
	
	function restore($id) {
	
		$LOG = new Log();
		$user_query = DB_query("SELECT
					*
					FROM users
					WHERE users_id = '".$id."'");
		if (mysql_num_rows($user_query)==1) {
			
			$userdata = DB_fetchArray($user_query);
			//Get user information
			$this->id = $userdata['users_id'];
			$this->name = $userdata['name'];	
			$this->lastname = $userdata['lastname'];
			$this->email = $userdata['email'];
			
			$LOG->write('3','Nutzername :'.$this->name);
			
			$this->role = $userdata['role_id']; // zusätzlich auch die Rollen-ID speichern

			//Get permissions
			$perm_query = DB_query("SELECT 
						*
						FROM roles
						WHERE role_id = ".$userdata['role_id']);
			$perm = DB_fetchArray($perm_query);
			$this->read_orders = $perm['read_orders'];
			$this->write_orders = $perm['write_orders'];
			$this->purchase = $perm['purchase'];
			$this->write_content = $perm['write_content'];
			$this->read_content = $perm['read_content'];
			
			
			$LOG->write('3','Berechtigungen :'.$this->read.$this->write.$this->purchase);
			$LOG->write('3','Benutzer wiederhergestellt:'.$this->name);
		} else {
			$LOG->write('3','Benutzer konnte nicht wiederhergestellt werden');
		}
	}
	
	function login($sign, $password) {
		$LOG = new Log();
		
		$user_query = DB_query("SELECT
					*
					FROM users
					WHERE name = '".$sign."'
					AND password = '".$password."'");
		if (mysql_num_rows($user_query)==1) {
			$userdata = DB_fetchArray($user_query);
			//Get user information
			$this->id = $userdata['users_id'];
			$this->name = $userdata['name'];	
			$this->lastname = $userdata['lastname'];
			$this->email = $userdata['email'];
			
			$LOG->write('2','Benutzer angemeldet :'.$this->name);	
			
			$this->role = $userdata['role_id']; // zusätzlich auch die Rollen-ID speichern

			//Get permissions
			$perm_query = DB_query("SELECT 
						*
						FROM roles
						WHERE role_id = ".$userdata['role_id']);
			$perm = DB_fetchArray($perm_query);
			$this->read_orders = $perm['read_orders'];
			$this->write_orders = $perm['write_orders'];
			$this->purchase = $perm['purchase'];
			$this->write_content = $perm['write_content'];
			$this->read_content = $perm['read_content'];
			
			$_SESSION['user']=$this->id;
			$LOG->write('2','Benutzer angemeldet: '.$this->name);

			return true;

		} else {
			$LOG->write('2','Benutzer konnte nicht angemeldet werden: '.$sign);
			return false;
		}
	}
	
	function logout() {
		$LOG = new Log();
		unset($_SESSION['user']);
		$LOG->write('2','Benutzer abgemeldet: '.$this->name);
		session_destroy();
	}
	
	function checkPermissions($read_content=0,$write_content=0,$purchase=0,$read_orders=0,$write_orders=0) {
		if ($this->read_content>=$read_content &&
			$this->write_content>=$write_content && 
			$this->purchase>=$purchase &&
			$this->read_orders>=$read_orders &&
			$this->write_orders>=$write_orders) {
			return true;
		} else {
			return false;
		}
	}

	function getID(){
		return $this->id;
	}

	function getName(){
		return $this->name;
	}

	function getLastname(){
		return $this->lastname;
	}

	function getEmail(){
		return $this->email;
	}
}

?>